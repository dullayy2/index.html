<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playlist Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">üéµ Spotify Playlist Organizer</h1>
            <p class="text-gray-600 text-lg">Automatically organize your liked songs into playlists by genre and artist location</p>
        </div>

        <div id="app"></div>
    </div>

    <script>
        const CLIENT_ID = '9a3ce47d27f94da4b14cff1a07fe9a7a';
        const REDIRECT_URI = const REDIRECT_URI = "https://dullayy2.github.io/";
        const SCOPES = [
            'user-library-read',
            'playlist-modify-public',
            'playlist-modify-private'
        ].join(' ');

        let currentStep = 'auth';
        let organizing = false;
        let progress = 0;
        let results = null;

        function generateAuthUrl() {
            const params = new URLSearchParams({
                client_id: CLIENT_ID,
                response_type: 'token',
                redirect_uri: REDIRECT_URI,
                scope: SCOPES,
            });
            return `https://accounts.spotify.com/authorize?${params}`;
        }

        function getAccessToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get('access_token');
        }

        function handleAuth() {
            window.location.href = generateAuthUrl();
        }

        async function fetchLikedSongs(token) {
            const songs = [];
            let url = 'https://api.spotify.com/v1/me/tracks?limit=50';

            while (url) {
                const response = await fetch(url, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await response.json();
                songs.push(...data.items);
                url = data.next;
            }

            return songs;
        }

        async function analyzeSongs(token, songs) {
            const analyzed = [];
            const total = songs.length;

            for (let i = 0; i < songs.length; i++) {
                const item = songs[i];
                const track = item.track;
                
                try {
                    const artistResponse = await fetch(
                        `https://api.spotify.com/v1/artists/${track.artists[0].id}`,
                        { headers: { Authorization: `Bearer ${token}` } }
                    );
                    const artistData = await artistResponse.json();

                    analyzed.push({
                        track,
                        genres: artistData.genres && artistData.genres.length > 0 ? artistData.genres : ['Unknown'],
                        location: 'Unknown' // Simplified for this version
                    });

                    // Update progress
                    progress = 40 + Math.floor((i / total) * 20);
                    render();
                } catch (error) {
                    console.error('Error analyzing track:', track.name, error);
                }
            }

            return analyzed;
        }

        function groupSongs(analyzed) {
            const byGenre = {};

            analyzed.forEach(({ track, genres }) => {
                genres.forEach(genre => {
                    if (!byGenre[genre]) byGenre[genre] = [];
                    byGenre[genre].push(track);
                });
            });

            return { byGenre };
        }

        async function getUserId(token) {
            const response = await fetch('https://api.spotify.com/v1/me', {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await response.json();
            return data.id;
        }

        async function createPlaylist(token, userId, name, description) {
            const response = await fetch(
                `https://api.spotify.com/v1/users/${userId}/playlists`,
                {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description, public: false })
                }
            );
            return response.json();
        }

        async function addTracksToPlaylist(token, playlistId, tracks) {
            const uris = tracks.map(t => t.uri);
            const chunks = [];
            for (let i = 0; i < uris.length; i += 100) {
                chunks.push(uris.slice(i, i + 100));
            }

            for (const chunk of chunks) {
                await fetch(
                    `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
                    {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ uris: chunk })
                    }
                );
            }
        }

        async function createPlaylists(token, grouped) {
            const userId = await getUserId(token);
            const created = { genres: [] };

            const entries = Object.entries(grouped.byGenre);
            for (let i = 0; i < entries.length; i++) {
                const [genre, tracks] = entries[i];
                if (tracks.length >= 5) {
                    const playlist = await createPlaylist(
                        token,
                        userId,
                        `${genre.charAt(0).toUpperCase() + genre.slice(1)} Mix`,
                        `Auto-generated playlist for ${genre} music`
                    );
                    await addTracksToPlaylist(token, playlist.id, tracks);
                    created.genres.push({ name: genre, count: tracks.length });

                    progress = 80 + Math.floor((i / entries.length) * 20);
                    render();
                }
            }

            return created;
        }

        async function organizePlaylists() {
            const token = getAccessToken();
            if (!token) {
                alert('Please authorize with Spotify first');
                return;
            }

            organizing = true;
            progress = 0;
            render();

            try {
                progress = 10;
                render();

                const likedSongs = await fetchLikedSongs(token);
                progress = 30;
                render();

                const analyzed = await analyzeSongs(token, likedSongs);
                progress = 60;
                render();

                const grouped = groupSongs(analyzed);
                progress = 70;
                render();

                const created = await createPlaylists(token, grouped);
                progress = 100;
                results = created;
                currentStep = 'results';
                render();
            } catch (error) {
                alert('Error organizing playlists: ' + error.message);
                console.error(error);
            } finally {
                organizing = false;
                render();
            }
        }

        function render() {
            const app = document.getElementById('app');

            if (currentStep === 'auth') {
                app.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <div class="text-center space-y-6">
                            <div class="flex justify-center gap-8 mb-8">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                        <span class="text-3xl">üéµ</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Genre-based</p>
                                </div>
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                        <span class="text-3xl">üìç</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Location-based</p>
                                </div>
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                        <span class="text-3xl">üìù</span>
                                    </div>
                                    <p class="text-sm text-gray-600">Auto-organized</p>
                                </div>
                            </div>

                            <button
                                onclick="handleAuth()"
                                class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors"
                            >
                                ‚ñ∂Ô∏è Connect to Spotify
                            </button>

                            <div class="text-left bg-gray-50 rounded-lg p-6 mt-8">
                                <h3 class="font-semibold text-gray-900 mb-3">‚öôÔ∏è Setup Instructions</h3>
                                <ol class="space-y-2 text-sm text-gray-700 list-decimal list-inside">
                                    <li>Save this HTML file to your computer</li>
                                    <li>Open it in your browser</li>
                                    <li>Update your Spotify app's Redirect URI to match the file's URL</li>
                                    <li>Click "Connect to Spotify"</li>
                                </ol>
                                <p class="text-xs text-gray-500 mt-4">Current URL: <code class="bg-white px-2 py-1 rounded">${REDIRECT_URI}</code></p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentStep === 'organize') {
                app.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <div class="text-center space-y-6">
                            <span class="text-6xl">‚ù§Ô∏è</span>
                            <h2 class="text-2xl font-bold text-gray-900">Ready to Organize!</h2>
                            <p class="text-gray-600">
                                Click the button below to analyze your liked songs and create organized playlists
                            </p>

                            ${organizing ? `
                                <div class="space-y-4">
                                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                        <div
                                            class="bg-green-600 h-full transition-all duration-300 rounded-full"
                                            style="width: ${progress}%"
                                        ></div>
                                    </div>
                                    <p class="text-sm text-gray-600">Organizing your music... ${progress}%</p>
                                </div>
                            ` : `
                                <button
                                    onclick="organizePlaylists()"
                                    class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors"
                                >
                                    Start Organizing
                                </button>
                            `}
                        </div>
                    </div>
                `;
            } else if (currentStep === 'results' && results) {
                app.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-3xl">üéµ</span>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Playlists Created!</h2>
                            <p class="text-gray-600">Check your Spotify account for your new organized playlists</p>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-6">
                            <h3 class="font-semibold text-lg mb-4">üéµ Genre Playlists</h3>
                            <div class="space-y-2">
                                ${results.genres.map(g => `
                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                        <span class="text-gray-900">${g.name}</span>
                                        <span class="text-sm text-gray-500">${g.count} songs</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mt-6 text-center">
                            <a
                                href="https://open.spotify.com"
                                target="_blank"
                                class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"
                            >
                                Open Spotify
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        // Check for access token on page load
        if (window.location.hash.includes('access_token')) {
            currentStep = 'organize';
        }

        render();
    </script>
</body>
</html>
